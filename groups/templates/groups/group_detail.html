{% extends "base.html" %}

{% block title %}{{ group.name }}{% endblock %}

{% block content %}
  <div class="flex flex-col gap-4">
    <div class="breadcrumbs text-sm">
      <ul>
        <li><a href="/groups/">Groups</a></li>
        <li>{{ group.name }}</li>
      </ul>
    </div>

    <div class="card bg-base-100">
      <div class="card-body">
        <div class="flex items-start justify-between gap-4">
          <div>
            <h1 class="text-3xl font-bold">{{ group.name }}</h1>

            {% if group.image_url %}
              <figure class="mt-3">
                <img class="rounded-box w-full max-w-xl" src="{{ group.image_url }}" alt="{{ group.name }}" />
              </figure>
            {% endif %}

            {% if group.description %}
              <p class="text-base text-base-content mt-2">{{ group.description }}</p>
            {% endif %}

            {% if is_owner %}
              <div class="mt-4">
                <form class="flex flex-col md:flex-row gap-2" method="post" action="{% url 'groups:update_image' group.id %}">
                  {% csrf_token %}
                  <input class="input input-bordered w-full" name="image_url" value="{{ group.image_url }}" placeholder="Group image URL" />
                  <button class="btn btn-secondary" type="submit">Update image</button>
                </form>
                <div class="text-sm opacity-70 mt-1">Paste an image URL to add/replace the group image.</div>
              </div>
            {% endif %}
          </div>

          <form method="post" action="/groups/{{ group.id }}/leave/">
            {% csrf_token %}
            <button class="btn btn-secondary" type="submit">Leave</button>
          </form>
        </div>
      </div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <div class="card bg-base-100">
        <div class="card-body">
          <h2 class="text-xl font-semibold mb-2">Members</h2>

          {% if is_owner %}
            <form method="post" action="/groups/{{ group.id }}/members/add/" class="flex flex-col md:flex-row gap-2 mb-4">
              {% csrf_token %}
              <input class="input input-bordered w-full" name="username" placeholder="Username to add" required />
              <button class="btn btn-secondary" type="submit">Add member</button>
            </form>
          {% endif %}

          <div class="space-y-2">
            {% for m in group.members.all %}
              <div class="flex items-center justify-between">
                <div>{{ m.username }}</div>
                <div class="flex items-center gap-2">
                  {% if m.id == group.owner_id %}
                    <div class="badge badge-accent">Leader</div>
                  {% endif %}

                  {% if is_owner and m.id != group.owner_id %}
                    <form method="post" action="/groups/{{ group.id }}/members/{{ m.id }}/remove/">
                      {% csrf_token %}
                      <button class="btn btn-ghost btn-xs" type="submit">Remove</button>
                    </form>
                  {% endif %}
                </div>
              </div>
            {% endfor %}
          </div>
        </div>
      </div>

      <div class="card bg-base-100">
        <div class="card-body">
          <h2 class="text-xl font-semibold mb-2">Recent donations</h2>
          <div class="space-y-2">
            {% for d in donations %}
              <div class="flex items-center justify-between">
                <div class="text-sm">
                  <div class="font-semibold">{{ d.amount|floatformat:0 }} ₫</div>
                  <div class="text-base-content/70">{{ d.campaign.title }} • {{ d.created_at }}</div>
                </div>
                <div class="text-sm text-base-content/70">by {{ d.public_name }}</div>
              </div>
            {% empty %}
              <div class="text-sm text-base-content/70">No donations yet.</div>
            {% endfor %}
          </div>
        </div>
      </div>

      <div class="card bg-base-100 md:col-span-2">
        <div class="card-body">
          <h2 class="text-xl font-semibold mb-2">Messages</h2>

          <form method="post" action="{% url 'groups:post_message' group.id %}" class="flex flex-col md:flex-row gap-2 mb-4">
            {% csrf_token %}
            <input class="input input-bordered w-full" name="content" placeholder="Write a message..." />
            <button class="btn btn-primary" type="submit">Send</button>
          </form>

          <div class="space-y-2">
            {% for m in messages %}
              <div class="card bg-base-200">
                <div class="card-body">
                  <div class="flex items-center justify-between gap-4">
                    <div class="font-semibold">{{ m.sender.username }}</div>
                    <div class="text-sm opacity-70">{{ m.created_at }}</div>
                  </div>
                  <div class="mt-1">{{ m.content }}</div>
                </div>
              </div>
            {% empty %}
              <div class="alert alert-info"><span>No messages yet.</span></div>
            {% endfor %}
          </div>
        </div>
      </div>
    </div>
  </div>
{% endblock %}
